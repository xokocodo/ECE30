#include <stdio.h>
#include <math.h>
#include <lpc2148/lpc214x.h>
#include "qmath.h"
#include <lpc2148/openlpc.h>

int csubmillis(void){
        return submillis();
}

extern void lab5();		// defined in lab5.S

// lookup table for for unity-scaled sin wave over [0, pi] in q16.16 format
static const fixedp SIN_LUT[] = {
0x0, 0xc9, 0x192, 0x25b, 0x324, 0x3ed, 0x4b6, 0x57f, 0x648, 0x711, 0x7da, 0x8a3, 0x96c, 0xa35, 0xafe, 0xbc6, 0xc8f, 0xd58, 0xe21, 0xeea, 0xfb2, 0x107b, 0x1144, 0x120c, 0x12d5, 0x139d, 0x1466, 0x152e, 0x15f6, 0x16bf, 0x1787, 0x184f, 0x1917,
0x19df, 0x1aa7, 0x1b6f, 0x1c37, 0x1cff, 0x1dc7, 0x1e8e, 0x1f56, 0x201d, 0x20e5, 0x21ac, 0x2273, 0x233b, 0x2402, 0x24c9, 0x2590, 0x2656, 0x271d, 0x27e4, 0x28aa, 0x2971, 0x2a37, 0x2afe, 0x2bc4, 0x2c8a, 0x2d50, 0x2e15, 0x2edb, 0x2fa1, 0x3066, 0x312c, 0x31f1,
0x32b6, 0x337b, 0x3440, 0x3505, 0x35c9, 0x368e, 0x3752, 0x3817, 0x38db, 0x399f, 0x3a62, 0x3b26, 0x3bea, 0x3cad, 0x3d70, 0x3e33, 0x3ef6, 0x3fb9, 0x407c, 0x413e, 0x4201, 0x42c3, 0x4385, 0x4447, 0x4508, 0x45ca, 0x468b, 0x474d, 0x480e, 0x48ce, 0x498f, 0x4a50,
0x4b10, 0x4bd0, 0x4c90, 0x4d50, 0x4e0f, 0x4ecf, 0x4f8e, 0x504d, 0x510c, 0x51ca, 0x5289, 0x5347, 0x5405, 0x54c3, 0x5581, 0x563e, 0x56fb, 0x57b8, 0x5875, 0x5931, 0x59ee, 0x5aaa, 0x5b66, 0x5c22, 0x5cdd, 0x5d98, 0x5e53, 0x5f0e, 0x5fc9, 0x6083, 0x613d, 0x61f7,
0x62b1, 0x636a, 0x6423, 0x64dc, 0x6595, 0x664d, 0x6705, 0x67bd, 0x6875, 0x692d, 0x69e4, 0x6a9b, 0x6b51, 0x6c08, 0x6cbe, 0x6d74, 0x6e29, 0x6edf, 0x6f94, 0x7049, 0x70fd, 0x71b1, 0x7265, 0x7319, 0x73cd, 0x7480, 0x7533, 0x75e5, 0x7698, 0x774a, 0x77fb, 0x78ad,
0x795e, 0x7a0f, 0x7ac0, 0x7b70, 0x7c20, 0x7cd0, 0x7d7f, 0x7e2e, 0x7edd, 0x7f8b, 0x803a, 0x80e7, 0x8195, 0x8242, 0x82ef, 0x839c, 0x8448, 0x84f4, 0x85a0, 0x864b, 0x86f6, 0x87a1, 0x884b, 0x88f5, 0x899f, 0x8a48, 0x8af1, 0x8b9a, 0x8c42, 0x8cea, 0x8d92, 0x8e39,
0x8ee0, 0x8f87, 0x902d, 0x90d3, 0x9179, 0x921e, 0x92c3, 0x9368, 0x940c, 0x94b0, 0x9553, 0x95f6, 0x9699, 0x973c, 0x97de, 0x987f, 0x9921, 0x99c2, 0x9a62, 0x9b02, 0x9ba2, 0x9c42, 0x9ce1, 0x9d7f, 0x9e1e, 0x9ebc, 0x9f59, 0x9ff6, 0xa093, 0xa12f, 0xa1cb, 0xa267,
0xa302, 0xa39d, 0xa438, 0xa4d2, 0xa56b, 0xa605, 0xa69d, 0xa736, 0xa7ce, 0xa866, 0xa8fd, 0xa994, 0xaa2a, 0xaac0, 0xab56, 0xabeb, 0xac80, 0xad14, 0xada8, 0xae3b, 0xaece, 0xaf61, 0xaff3, 0xb085, 0xb117, 0xb1a8, 0xb238, 0xb2c8, 0xb358, 0xb3e7, 0xb476, 0xb504,
0xb592, 0xb620, 0xb6ad, 0xb73a, 0xb7c6, 0xb852, 0xb8dd, 0xb968, 0xb9f2, 0xba7c, 0xbb06, 0xbb8f, 0xbc17, 0xbca0, 0xbd27, 0xbdae, 0xbe35, 0xbebc, 0xbf41, 0xbfc7, 0xc04c, 0xc0d0, 0xc154, 0xc1d8, 0xc25b, 0xc2de, 0xc360, 0xc3e2, 0xc463, 0xc4e3, 0xc564, 0xc5e4,
0xc663, 0xc6e2, 0xc760, 0xc7de, 0xc85b, 0xc8d8, 0xc955, 0xc9d1, 0xca4c, 0xcac7, 0xcb41, 0xcbbb, 0xcc35, 0xccae, 0xcd26, 0xcd9f, 0xce16, 0xce8d, 0xcf04, 0xcf7a, 0xcfef, 0xd064, 0xd0d9, 0xd14d, 0xd1c0, 0xd233, 0xd2a6, 0xd318, 0xd389, 0xd3fa, 0xd46b, 0xd4db,
0xd54a, 0xd5b9, 0xd627, 0xd695, 0xd703, 0xd770, 0xd7dc, 0xd848, 0xd8b3, 0xd91e, 0xd988, 0xd9f2, 0xda5b, 0xdac4, 0xdb2c, 0xdb94, 0xdbfb, 0xdc61, 0xdcc7, 0xdd2d, 0xdd92, 0xddf6, 0xde5a, 0xdebe, 0xdf20, 0xdf83, 0xdfe4, 0xe046, 0xe0a6, 0xe106, 0xe166, 0xe1c5,
0xe224, 0xe282, 0xe2df, 0xe33c, 0xe398, 0xe3f4, 0xe44f, 0xe4aa, 0xe504, 0xe55e, 0xe5b7, 0xe60f, 0xe667, 0xe6be, 0xe715, 0xe76b, 0xe7c1, 0xe816, 0xe86b, 0xe8bf, 0xe912, 0xe965, 0xe9b7, 0xea09, 0xea5a, 0xeaab, 0xeafb, 0xeb4b, 0xeb99, 0xebe8, 0xec36, 0xec83,
0xecd0, 0xed1c, 0xed67, 0xedb2, 0xedfc, 0xee46, 0xee8f, 0xeed8, 0xef20, 0xef68, 0xefaf, 0xeff5, 0xf03b, 0xf080, 0xf0c5, 0xf109, 0xf14c, 0xf18f, 0xf1d1, 0xf213, 0xf254, 0xf294, 0xf2d4, 0xf314, 0xf353, 0xf391, 0xf3ce, 0xf40b, 0xf448, 0xf484, 0xf4bf, 0xf4fa,
0xf534, 0xf56d, 0xf5a6, 0xf5de, 0xf616, 0xf64d, 0xf684, 0xf6ba, 0xf6ef, 0xf724, 0xf758, 0xf78b, 0xf7be, 0xf7f1, 0xf822, 0xf853, 0xf884, 0xf8b4, 0xf8e3, 0xf912, 0xf940, 0xf96e, 0xf99b, 0xf9c7, 0xf9f3, 0xfa1e, 0xfa49, 0xfa73, 0xfa9c, 0xfac5, 0xfaed, 0xfb14,
0xfb3b, 0xfb61, 0xfb87, 0xfbac, 0xfbd1, 0xfbf5, 0xfc18, 0xfc3b, 0xfc5d, 0xfc7e, 0xfc9f, 0xfcbf, 0xfcdf, 0xfcfe, 0xfd1c, 0xfd3a, 0xfd57, 0xfd74, 0xfd90, 0xfdab, 0xfdc6, 0xfde0, 0xfdfa, 0xfe13, 0xfe2b, 0xfe43, 0xfe5a, 0xfe70, 0xfe86, 0xfe9b, 0xfeb0, 0xfec4,
0xfed7, 0xfeea, 0xfefc, 0xff0e, 0xff1f, 0xff2f, 0xff3f, 0xff4e, 0xff5c, 0xff6a, 0xff78, 0xff84, 0xff90, 0xff9c, 0xffa6, 0xffb1, 0xffba, 0xffc3, 0xffcb, 0xffd3, 0xffda, 0xffe1, 0xffe7, 0xffec, 0xfff0, 0xfff4, 0xfff8, 0xfffb, 0xfffd, 0xfffe, 0xffff, 0x10000,
0xffff, 0xfffe, 0xfffd, 0xfffb, 0xfff8, 0xfff4, 0xfff0, 0xffec, 0xffe7, 0xffe1, 0xffda, 0xffd3, 0xffcb, 0xffc3, 0xffba, 0xffb1, 0xffa6, 0xff9c, 0xff90, 0xff84, 0xff78, 0xff6a, 0xff5c, 0xff4e, 0xff3f, 0xff2f, 0xff1f, 0xff0e, 0xfefc, 0xfeea, 0xfed7, 0xfec4,
0xfeb0, 0xfe9b, 0xfe86, 0xfe70, 0xfe5a, 0xfe43, 0xfe2b, 0xfe13, 0xfdfa, 0xfde0, 0xfdc6, 0xfdab, 0xfd90, 0xfd74, 0xfd57, 0xfd3a, 0xfd1c, 0xfcfe, 0xfcdf, 0xfcbf, 0xfc9f, 0xfc7e, 0xfc5d, 0xfc3b, 0xfc18, 0xfbf5, 0xfbd1, 0xfbac, 0xfb87, 0xfb61, 0xfb3b, 0xfb14,
0xfaed, 0xfac5, 0xfa9c, 0xfa73, 0xfa49, 0xfa1e, 0xf9f3, 0xf9c7, 0xf99b, 0xf96e, 0xf940, 0xf912, 0xf8e3, 0xf8b4, 0xf884, 0xf853, 0xf822, 0xf7f1, 0xf7be, 0xf78b, 0xf758, 0xf724, 0xf6ef, 0xf6ba, 0xf684, 0xf64d, 0xf616, 0xf5de, 0xf5a6, 0xf56d, 0xf534, 0xf4fa,
0xf4bf, 0xf484, 0xf448, 0xf40b, 0xf3ce, 0xf391, 0xf353, 0xf314, 0xf2d4, 0xf294, 0xf254, 0xf213, 0xf1d1, 0xf18f, 0xf14c, 0xf109, 0xf0c5, 0xf080, 0xf03b, 0xeff5, 0xefaf, 0xef68, 0xef20, 0xeed8, 0xee8f, 0xee46, 0xedfc, 0xedb2, 0xed67, 0xed1c, 0xecd0, 0xec83,
0xec36, 0xebe8, 0xeb99, 0xeb4b, 0xeafb, 0xeaab, 0xea5a, 0xea09, 0xe9b7, 0xe965, 0xe912, 0xe8bf, 0xe86b, 0xe816, 0xe7c1, 0xe76b, 0xe715, 0xe6be, 0xe667, 0xe60f, 0xe5b7, 0xe55e, 0xe504, 0xe4aa, 0xe44f, 0xe3f4, 0xe398, 0xe33c, 0xe2df, 0xe282, 0xe224, 0xe1c5,
0xe166, 0xe106, 0xe0a6, 0xe046, 0xdfe4, 0xdf83, 0xdf20, 0xdebe, 0xde5a, 0xddf6, 0xdd92, 0xdd2d, 0xdcc7, 0xdc61, 0xdbfb, 0xdb94, 0xdb2c, 0xdac4, 0xda5b, 0xd9f2, 0xd988, 0xd91e, 0xd8b3, 0xd848, 0xd7dc, 0xd770, 0xd703, 0xd695, 0xd627, 0xd5b9, 0xd54a, 0xd4db,
0xd46b, 0xd3fa, 0xd389, 0xd318, 0xd2a6, 0xd233, 0xd1c0, 0xd14d, 0xd0d9, 0xd064, 0xcfef, 0xcf7a, 0xcf04, 0xce8d, 0xce16, 0xcd9f, 0xcd26, 0xccae, 0xcc35, 0xcbbb, 0xcb41, 0xcac7, 0xca4c, 0xc9d1, 0xc955, 0xc8d8, 0xc85b, 0xc7de, 0xc760, 0xc6e2, 0xc663, 0xc5e4,
0xc564, 0xc4e3, 0xc463, 0xc3e2, 0xc360, 0xc2de, 0xc25b, 0xc1d8, 0xc154, 0xc0d0, 0xc04c, 0xbfc7, 0xbf41, 0xbebc, 0xbe35, 0xbdae, 0xbd27, 0xbca0, 0xbc17, 0xbb8f, 0xbb06, 0xba7c, 0xb9f2, 0xb968, 0xb8dd, 0xb852, 0xb7c6, 0xb73a, 0xb6ad, 0xb620, 0xb592, 0xb504,
0xb476, 0xb3e7, 0xb358, 0xb2c8, 0xb238, 0xb1a8, 0xb117, 0xb085, 0xaff3, 0xaf61, 0xaece, 0xae3b, 0xada8, 0xad14, 0xac80, 0xabeb, 0xab56, 0xaac0, 0xaa2a, 0xa994, 0xa8fd, 0xa866, 0xa7ce, 0xa736, 0xa69d, 0xa605, 0xa56b, 0xa4d2, 0xa438, 0xa39d, 0xa302, 0xa267,
0xa1cb, 0xa12f, 0xa093, 0x9ff6, 0x9f59, 0x9ebc, 0x9e1e, 0x9d7f, 0x9ce1, 0x9c42, 0x9ba2, 0x9b02, 0x9a62, 0x99c2, 0x9921, 0x987f, 0x97de, 0x973c, 0x9699, 0x95f6, 0x9553, 0x94b0, 0x940c, 0x9368, 0x92c3, 0x921e, 0x9179, 0x90d3, 0x902d, 0x8f87, 0x8ee0, 0x8e39,
0x8d92, 0x8cea, 0x8c42, 0x8b9a, 0x8af1, 0x8a48, 0x899f, 0x88f5, 0x884b, 0x87a1, 0x86f6, 0x864b, 0x85a0, 0x84f4, 0x8448, 0x839c, 0x82ef, 0x8242, 0x8195, 0x80e7, 0x803a, 0x7f8b, 0x7edd, 0x7e2e, 0x7d7f, 0x7cd0, 0x7c20, 0x7b70, 0x7ac0, 0x7a0f, 0x795e, 0x78ad,
0x77fb, 0x774a, 0x7698, 0x75e5, 0x7533, 0x7480, 0x73cd, 0x7319, 0x7265, 0x71b1, 0x70fd, 0x7049, 0x6f94, 0x6edf, 0x6e29, 0x6d74, 0x6cbe, 0x6c08, 0x6b51, 0x6a9b, 0x69e4, 0x692d, 0x6875, 0x67bd, 0x6705, 0x664d, 0x6595, 0x64dc, 0x6423, 0x636a, 0x62b1, 0x61f7,
0x613d, 0x6083, 0x5fc9, 0x5f0e, 0x5e53, 0x5d98, 0x5cdd, 0x5c22, 0x5b66, 0x5aaa, 0x59ee, 0x5931, 0x5875, 0x57b8, 0x56fb, 0x563e, 0x5581, 0x54c3, 0x5405, 0x5347, 0x5289, 0x51ca, 0x510c, 0x504d, 0x4f8e, 0x4ecf, 0x4e0f, 0x4d50, 0x4c90, 0x4bd0, 0x4b10, 0x4a50,
0x498f, 0x48ce, 0x480e, 0x474d, 0x468b, 0x45ca, 0x4508, 0x4447, 0x4385, 0x42c3, 0x4201, 0x413e, 0x407c, 0x3fb9, 0x3ef6, 0x3e33, 0x3d70, 0x3cad, 0x3bea, 0x3b26, 0x3a62, 0x399f, 0x38db, 0x3817, 0x3752, 0x368e, 0x35c9, 0x3505, 0x3440, 0x337b, 0x32b6, 0x31f1,
0x312c, 0x3066, 0x2fa1, 0x2edb, 0x2e15, 0x2d50, 0x2c8a, 0x2bc4, 0x2afe, 0x2a37, 0x2971, 0x28aa, 0x27e4, 0x271d, 0x2656, 0x2590, 0x24c9, 0x2402, 0x233b, 0x2273, 0x21ac, 0x20e5, 0x201d, 0x1f56, 0x1e8e, 0x1dc7, 0x1cff, 0x1c37, 0x1b6f, 0x1aa7, 0x19df, 0x1917,
0x184f, 0x1787, 0x16bf, 0x15f6, 0x152e, 0x1466, 0x139d, 0x12d5, 0x120c, 0x1144, 0x107b, 0xfb2, 0xeea, 0xe21, 0xd58, 0xc8f, 0xbc6, 0xafe, 0xa35, 0x96c, 0x8a3, 0x7da, 0x711, 0x648, 0x57f, 0x4b6, 0x3ed, 0x324, 0x25b, 0x192, 0xc9, 0
};  // SIN_LUT




// Uses the lookup table and linear interpolation to generate a sin wave
int fixed_sin(int theta)
{
	int neg = 0;
	int n1;
	fixedp y, y1, y2;
	fixedp x = qmod(theta, Q2PI);

	if (x < 0)
		x += Q2PI;

	if (x > QPI) {
		neg = 1;
		x -= QPI;
	}

	// x is now in the range [0, pi]. Need to map that to range [0, 1023]
	// use linear interpolation
	x = qmul(qdiv(x, QPI), int2q(1024));		// x is now in the range [0, 1023]
	n1 = q2int(x);
	y1 = SIN_LUT[n1];
	y2 = SIN_LUT[n1 + 1];
	y = y1 + qmul(y2 - y1, x - qfloor(x));

	return neg ? -y : y;
}

int compute_duty(int i, int n) {
	return q2int(qmul(int2q(50), fixed_sin(qmul(double2q(2.0*M_PI*0.5*0.01), int2q(n)) - qmul(double2q(M_PI/8.0), int2q(i)) + double2q(M_PI/2.0)) + int2q(1)));
}

int main (void)
{
	// select P0.0-P0.7 as outputs
	FIO0DIR |= 0xff;

	while(1) {
		lab5();
		/* int n = 0;
    unsigned int offTime[8];
    unsigned int end = submillis() + 40000;
    unsigned int nextDuty = 0;
    while(submillis() < end) {
        if(submillis() >= nextDuty) {       // beginning of duty cycle
            unsigned int now = submillis();
            nextDuty = now + 100;
            
            // for each LED, compute the time at which it should be turned off
            for(int i = 0; i < 8; i++) {
                offTime[i] = now + compute_duty(i, n);
            }

            // turn on all LEDs
            FIO0CLR = 0xff;

            n++;
            if(n >= 1000) {
                n = 0;
            }
        }

        // check duty cycle completion
        for(int i = 0; i < 8; i++) {
            // does LED i need to be turned off?
            if(submillis() >= offTime[i]) {
                FIO0SET = 1 << i;
            }
        }
    }
	
	*/
}
	return 0;
}
